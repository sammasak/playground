---
// Chess Board Component with Bot Support
// Ensure base URL ends with a slash for proper path concatenation
const rawBase = import.meta.env.BASE_URL || '/';
const base = rawBase.endsWith('/') ? rawBase : rawBase + '/';

const witCode = `// WIT interface for chess bot plugins
package chess:bot@0.1.0;

interface types {
    enum piece-type {
        pawn, knight, bishop, rook, queen, king
    }
    enum color { white, black }

    record piece {
        piece-type: piece-type,
        color: color,
    }

    type square = u8;    // 0=a1, 63=h8
    type move = string;  // UCI format: "e2e4", "e7e8q"

    record move-history-entry {
        uci-move: move,
        resulting-fen: string,
    }

    record board-state {
        squares: list<option<piece>>,
        turn: color,
        castling-rights: castling,
        en-passant: option<square>,
        halfmove-clock: u16,
        fullmove-number: u16,
        move-history: list<move-history-entry>,
    }

    record castling {
        white-kingside: bool,
        white-queenside: bool,
        black-kingside: bool,
        black-queenside: bool,
    }

    enum game-result {
        in-progress, checkmate, stalemate, draw,
    }
}

interface host {
    use types.{board-state, move, game-result};
    get-board: func() -> board-state;
    get-legal-moves: func() -> list<move>;
    is-check: func() -> bool;
    get-game-result: func() -> game-result;
    get-fen: func() -> string;
    log: func(message: string);
}

interface bot {
    use types.{move, color};
    get-name: func() -> string;
    get-description: func() -> string;
    get-preferred-color: func() -> option<color>;
    on-game-start: func();
    select-move: func() -> move;
    suggest-move: func() -> move;
}

world chess-bot {
    import host;
    export bot;
}`;

const pythonExample = `# Host functions (same API as compiled WASM components):
#   get_board()       -> board state dict with move history
#   get_legal_moves() -> list of UCI strings ["e2e4", ...]
#   is_check()        -> bool
#   get_fen()         -> FEN string
#   log(msg)          -> print to bot log
#   _pseudo_random(n) -> int in [0, n) for variety

def select_move():
    board = get_board()
    moves = get_legal_moves()

    # Strategy: prefer captures, then center control
    best = moves[_pseudo_random(len(moves))]
    center = [27, 28, 35, 36]  # d4, e4, d5, e5

    for m in moves:
        target_file = ord(m[2]) - ord('a')
        target_rank = int(m[3]) - 1
        target_idx = target_rank * 8 + target_file

        # Always take captures
        if board['squares'][target_idx] is not None:
            log("Capturing with " + m)
            return m

        # Prefer center squares
        if target_idx in center:
            best = m

    return best`;

const componentizePyExample = `# bot.py — compile with: componentize-py -w chess-bot componentize bot -o bot.wasm
from chess_bot.imports.host import (
    get_board, get_legal_moves, is_check, log
)
from chess_bot.types import Move, Color
import random  # available in full Python, not in playground

class Bot:
    def get_name(self) -> str:
        return "My Python Bot"

    def get_description(self) -> str:
        return "A strategic Python chess bot"

    def get_preferred_color(self) -> Color | None:
        return None

    def on_game_start(self) -> None:
        log("Let's play!")

    def select_move(self) -> Move:
        board = get_board()
        moves = get_legal_moves()

        # Prefer captures
        for m in moves:
            tf = ord(m[2]) - ord('a')
            tr = int(m[3]) - 1
            if board.squares[tr * 8 + tf] is not None:
                return m

        return random.choice(moves)

    def suggest_move(self) -> Move:
        return self.select_move()`;
---

<div id="chess-container">
  <div id="game-info">
    <div id="turn-indicator">White to move</div>
    <div id="game-status"></div>
  </div>

  <div id="main-content">
    <div id="board-column">
      <div id="board-section">
        <div id="chess-board"></div>
        <div id="controls">
          <button id="reset-btn">New Game</button>
          <button id="undo-btn" disabled>Undo</button>
        </div>
      </div>
      <div id="move-history">
        <h3>Move History</h3>
        <div id="moves-list"></div>
      </div>
    </div>

    <div id="side-panel">
      <div id="tab-bar">
        <button class="tab active" data-tab="wit-tab">Bot Interface</button>
        <button class="tab" data-tab="editor-tab">Python Editor</button>
        <button class="tab" data-tab="controls-tab">Controls</button>
      </div>

      <div id="tab-content">
        <!-- WIT Interface Tab -->
        <div id="wit-tab" class="tab-pane active">
          <div class="wit-section">
            <h4>WIT Interface Definition</h4>
            <p class="wit-desc">Bots receive the full board state (with move history) and legal moves, then return a UCI move string.</p>
            <pre id="wit-code" class="code-block">{witCode}</pre>
          </div>

          <div class="wit-section">
            <h4>Build a Bot with Python</h4>
            <p class="wit-desc">Compile to a WASM component with <a href="https://github.com/bytecodealliance/componentize-py" target="_blank">componentize-py</a>, or try the playground editor.</p>
            <pre class="code-block python-block">{componentizePyExample}</pre>
          </div>
        </div>

        <!-- Python Editor Tab -->
        <div id="editor-tab" class="tab-pane" style="display: none;">
          <div class="editor-header">
            <h4>Python Bot Playground</h4>
            <p class="editor-desc">Same host API as compiled components. Write <code>select_move()</code> and test instantly.</p>
            <p class="editor-desc"><em>Powered by <a href="https://github.com/pydantic/monty" target="_blank">Monty</a> — secure Python subset in WASM</em></p>
          </div>
          <textarea id="python-code" spellcheck="false">{pythonExample}</textarea>
          <div class="editor-actions">
            <button id="test-python">Test Code</button>
            <button id="apply-python">Apply to Bot</button>
          </div>
          <div id="python-error" style="display: none;"></div>
        </div>

        <!-- Controls Tab -->
        <div id="controls-tab" class="tab-pane" style="display: none;">
          <div class="controls-section">
            <h4>White Player</h4>
            <select id="white-player">
              <option value="human">Human</option>
              <option value="random-bot">Random Bot</option>
              <option value="python-bot">Python Bot</option>
              <option value="upload">Upload Bot...</option>
            </select>
            <div id="white-bot-mode" class="bot-mode" style="display: none;">
              <label><input type="radio" name="white-mode" value="auto" checked> Auto-play</label>
              <label><input type="radio" name="white-mode" value="suggest"> Suggest moves</label>
            </div>
          </div>

          <div class="controls-section">
            <h4>Black Player</h4>
            <select id="black-player">
              <option value="human">Human</option>
              <option value="random-bot">Random Bot</option>
              <option value="python-bot">Python Bot</option>
              <option value="upload">Upload Bot...</option>
            </select>
            <div id="black-bot-mode" class="bot-mode" style="display: none;">
              <label><input type="radio" name="black-mode" value="auto" checked> Auto-play</label>
              <label><input type="radio" name="black-mode" value="suggest"> Suggest moves</label>
            </div>
          </div>

          <div id="bot-vs-bot-controls" style="display: none;">
            <button id="start-match">Start Bot Match</button>
            <button id="pause-match" disabled>Pause</button>
            <label>
              Speed: <input type="range" id="match-speed" min="100" max="2000" value="500">
              <span id="speed-label">500ms</span>
            </label>
          </div>

          <div id="suggested-move" style="display: none;">
            <strong>Suggested move:</strong> <span id="suggestion"></span>
            <button id="play-suggestion">Play it</button>
          </div>

          <div id="bot-log">
            <h4>Bot Log</h4>
            <div id="log-content"></div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <input type="file" id="bot-upload" accept=".wasm,.js" style="display: none;">
</div>

<style is:global>
  #chess-container {
    display: flex;
    flex-direction: column;
    align-items: center;
    padding: 15px;
    font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
    width: 100%;
    max-width: 1200px;
    margin: 0 auto;
  }

  #game-info {
    margin-bottom: 12px;
    text-align: center;
  }

  #turn-indicator {
    font-size: 1.4rem;
    font-weight: bold;
    margin-bottom: 4px;
  }

  #game-status {
    font-size: 1.1rem;
    color: #e74c3c;
    min-height: 1.4em;
  }

  #main-content {
    display: flex;
    gap: 24px;
    align-items: flex-start;
    width: 100%;
  }

  #board-column {
    display: flex;
    flex-direction: column;
    align-items: center;
    flex-shrink: 0;
  }

  #board-section {
    display: flex;
    flex-direction: column;
    align-items: center;
  }

  #chess-board {
    display: grid;
    grid-template-columns: repeat(8, 60px);
    grid-template-rows: repeat(8, 60px);
    border: 3px solid #333;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
  }

  .square {
    width: 60px;
    height: 60px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 40px;
    cursor: pointer;
    user-select: none;
    transition: background-color 0.15s ease;
  }

  .square.light { background-color: #f0d9b5; }
  .square.dark { background-color: #b58863; }
  .square.selected { background-color: #7fa650 !important; }
  .square.suggested { background-color: #9dc3e6 !important; }
  .square.check { background-color: #e74c3c !important; }
  .square.last-move { background-color: #cdd26a !important; }

  .square.legal-move { position: relative; }
  .square.legal-move::after {
    content: '';
    position: absolute;
    width: 20px;
    height: 20px;
    background-color: rgba(0, 0, 0, 0.2);
    border-radius: 50%;
  }

  .square.legal-capture::after {
    content: '';
    position: absolute;
    width: 54px;
    height: 54px;
    border: 3px solid rgba(0, 0, 0, 0.2);
    border-radius: 50%;
    background: none;
  }

  #controls {
    margin-top: 12px;
    display: flex;
    gap: 10px;
  }

  button {
    padding: 8px 16px;
    font-size: 0.9rem;
    cursor: pointer;
    border: none;
    border-radius: 5px;
    background-color: #3498db;
    color: white;
    transition: background-color 0.2s;
  }

  button:hover:not(:disabled) {
    background-color: #2980b9;
  }

  button:disabled {
    background-color: #bdc3c7;
    cursor: not-allowed;
  }

  #move-history {
    margin-top: 16px;
    width: 486px;
    color: #333;
    background: white;
    padding: 12px;
    border-radius: 8px;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
  }

  #move-history h3 {
    margin: 0 0 8px 0;
    font-size: 0.95rem;
    color: #555;
  }

  #moves-list {
    display: flex;
    flex-wrap: wrap;
    gap: 4px;
    max-height: 100px;
    overflow-y: auto;
    padding: 8px;
    background: #f5f5f5;
    border-radius: 5px;
    min-height: 30px;
  }

  .move-entry {
    padding: 2px 6px;
    background: white;
    border-radius: 3px;
    font-family: monospace;
    font-size: 0.85rem;
  }

  /* Side Panel */
  #side-panel {
    flex: 1;
    min-width: 0;
    background: white;
    border-radius: 10px;
    box-shadow: 0 2px 12px rgba(0, 0, 0, 0.1);
    display: flex;
    flex-direction: column;
    max-height: 680px;
    color: #333;
  }

  #tab-bar {
    display: flex;
    border-bottom: 2px solid #e0e0e0;
    padding: 0;
    flex-shrink: 0;
  }

  .tab {
    flex: 1;
    padding: 12px 16px;
    background: transparent;
    color: #666;
    border: none;
    border-radius: 0;
    font-size: 0.9rem;
    font-weight: 600;
    cursor: pointer;
    position: relative;
    transition: color 0.2s;
  }

  .tab:hover {
    color: #333;
    background: #f5f5f5;
  }

  .tab.active {
    color: #3498db;
    background: transparent;
  }

  .tab.active::after {
    content: '';
    position: absolute;
    bottom: -2px;
    left: 0;
    right: 0;
    height: 2px;
    background: #3498db;
  }

  #tab-content {
    flex: 1;
    overflow-y: auto;
    padding: 16px;
  }

  .tab-pane {
    display: none;
  }

  .tab-pane.active {
    display: block;
  }

  /* WIT Tab */
  .wit-section {
    margin-bottom: 20px;
  }

  .wit-section h4 {
    margin: 0 0 6px 0;
    font-size: 0.95rem;
    color: #333;
  }

  .wit-desc {
    font-size: 0.85rem;
    color: #666;
    margin: 0 0 10px 0;
    line-height: 1.5;
  }

  .wit-desc a {
    color: #3498db;
    text-decoration: none;
  }

  .wit-desc a:hover {
    text-decoration: underline;
  }

  .code-block {
    background: #1e1e1e;
    color: #d4d4d4;
    padding: 14px;
    border-radius: 6px;
    font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', 'Consolas', monospace;
    font-size: 12px;
    line-height: 1.5;
    overflow-x: auto;
    white-space: pre;
    margin: 0;
    max-height: 400px;
    overflow-y: auto;
  }

  .python-block {
    max-height: 300px;
  }

  /* Editor Tab */
  .editor-header {
    margin-bottom: 12px;
  }

  .editor-header h4 {
    margin: 0 0 6px 0;
    font-size: 0.95rem;
  }

  .editor-desc {
    font-size: 0.85rem;
    color: #666;
    margin: 0 0 4px 0;
    line-height: 1.4;
  }

  .editor-desc code {
    background: #e8e8e8;
    padding: 1px 5px;
    border-radius: 3px;
    font-family: monospace;
    font-size: 0.85rem;
  }

  .editor-desc a {
    color: #3498db;
    text-decoration: none;
  }

  .editor-desc a:hover {
    text-decoration: underline;
  }

  #python-code {
    width: 100%;
    height: 320px;
    font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', 'Consolas', monospace;
    font-size: 13px;
    padding: 12px;
    border: 1px solid #333;
    border-radius: 6px;
    resize: vertical;
    background: #1e1e1e;
    color: #d4d4d4;
    line-height: 1.5;
    tab-size: 4;
    box-sizing: border-box;
  }

  .editor-actions {
    display: flex;
    gap: 8px;
    margin-top: 10px;
  }

  #test-python {
    background: #28a745;
  }

  #test-python:hover {
    background: #218838;
  }

  #apply-python {
    background: #6f42c1;
  }

  #apply-python:hover {
    background: #5a32a3;
  }

  #python-error {
    margin-top: 10px;
    padding: 10px;
    background: #f8d7da;
    border: 1px solid #f5c6cb;
    border-radius: 5px;
    color: #721c24;
    font-family: monospace;
    font-size: 0.85rem;
  }

  #python-error.success {
    background: #d4edda;
    border-color: #c3e6cb;
    color: #155724;
  }

  /* Controls Tab */
  .controls-section {
    margin-bottom: 16px;
    padding: 12px;
    background: #f5f5f5;
    border-radius: 6px;
  }

  .controls-section h4 {
    margin: 0 0 8px 0;
    font-size: 0.9rem;
    color: #555;
  }

  .controls-section select {
    width: 100%;
    padding: 8px;
    border-radius: 5px;
    border: 1px solid #ddd;
    font-size: 0.95rem;
  }

  .bot-mode {
    margin-top: 8px;
    display: flex;
    flex-direction: column;
    gap: 4px;
  }

  .bot-mode label {
    font-size: 0.9rem;
    cursor: pointer;
  }

  #bot-vs-bot-controls {
    margin-bottom: 16px;
    padding: 12px;
    background: #e8f4ea;
    border-radius: 6px;
  }

  #bot-vs-bot-controls button {
    margin-bottom: 8px;
    width: 100%;
  }

  #bot-vs-bot-controls label {
    display: flex;
    align-items: center;
    gap: 8px;
    font-size: 0.9rem;
  }

  #suggested-move {
    margin-bottom: 16px;
    padding: 12px;
    background: #fff3cd;
    border-radius: 6px;
    border: 1px solid #ffc107;
  }

  #suggested-move button {
    margin-top: 8px;
    width: 100%;
    background-color: #28a745;
  }

  #bot-log h4 {
    margin: 0 0 8px 0;
    font-size: 0.9rem;
    color: #555;
  }

  #log-content {
    font-family: monospace;
    font-size: 0.8rem;
    background: #f5f5f5;
    padding: 10px;
    border-radius: 5px;
    max-height: 200px;
    overflow-y: auto;
    min-height: 40px;
  }

  .log-entry {
    margin-bottom: 3px;
    color: #555;
  }

  /* Promotion Modal */
  .promotion-modal {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.5);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 1000;
  }

  .promotion-choices {
    background: white;
    padding: 20px;
    border-radius: 10px;
    display: flex;
    gap: 10px;
  }

  .promotion-choice {
    width: 60px;
    height: 60px;
    font-size: 40px;
    cursor: pointer;
    border: 2px solid #333;
    border-radius: 5px;
    background: #f0d9b5;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .promotion-choice:hover {
    background: #7fa650;
  }
</style>

<script type="module" define:vars={{ base }}>

  // --- Tab switching ---
  document.querySelectorAll('.tab').forEach(tab => {
    tab.addEventListener('click', () => {
      document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
      document.querySelectorAll('.tab-pane').forEach(p => {
        p.classList.remove('active');
        p.style.display = 'none';
      });
      tab.classList.add('active');
      const pane = document.getElementById(tab.dataset.tab);
      pane.classList.add('active');
      pane.style.display = 'block';
    });
  });

  // --- Chess Engine ---
  async function loadChessEngine() {
    const module = await import(`${base}wasm/chess_engine.js`);
    await module.default(`${base}wasm/chess_engine_bg.wasm`);
    return module;
  }

  let montyLoaded = false;
  let MontyClass = null;

  async function loadMonty() {
    if (montyLoaded) return;
    try {
      const module = await import(`${base}monty/monty_wasm.js`);
      await module.default(`${base}monty/monty_wasm_bg.wasm`);
      MontyClass = module.Monty;
      montyLoaded = true;
      addLogEntry('Python runtime (Monty) loaded');
    } catch (e) {
      addLogEntry(`Failed to load Python runtime: ${(e.message || String(e))}`);
      console.error(e);
    }
  }

  const PIECE_UNICODE = {
    white: { king: '\u2654', queen: '\u2655', rook: '\u2656', bishop: '\u2657', knight: '\u2658', pawn: '\u2659' },
    black: { king: '\u265A', queen: '\u265B', rook: '\u265C', bishop: '\u265D', knight: '\u265E', pawn: '\u265F' }
  };

  let game;
  let selectedSquare = null;
  let legalMoves = [];
  let moveHistory = [];
  let lastMove = null;
  let suggestedMove = null;
  let bots = { white: null, black: null };
  let botModes = { white: 'auto', black: 'auto' };
  let matchInterval = null;
  let matchPaused = false;
  let pythonBotCode = { white: null, black: null };

  // --- Python Host-Function Shim ---
  // Monty API: withInputs(code, names_json_array) creates instance,
  // then runWithInputs(values_json_object) executes with those values.
  // We use underscore-prefixed names to avoid conflicts, then wrap in functions.
  const PYTHON_INPUT_NAMES = ["_board", "_legal_moves", "_is_check", "_fen", "_seed"];
  const PYTHON_SHIM = `
def get_board():
    return _board

def get_legal_moves():
    return _legal_moves

def is_check():
    return _is_check

def get_fen():
    return _fen

def log(msg):
    pass

def _pseudo_random(n):
    return _seed % n if n > 0 else 0

`;

  function getPythonInputs() {
    const boardState = JSON.parse(game.get_board_state());
    const legalMoves = JSON.parse(game.get_legal_moves());
    return {
      _legal_moves: legalMoves,
      _board: {
        squares: boardState.squares,
        turn: boardState.turn,
        castling_rights: boardState.castling,
        en_passant: boardState.en_passant,
        halfmove_clock: boardState.halfmove_clock,
        fullmove_number: boardState.fullmove_number,
        move_history: boardState.move_history || [],
      },
      _is_check: game.is_check(),
      _fen: game.get_fen(),
      _seed: Math.floor(Math.random() * 2147483647),
    };
  }

  function executePythonBot(code) {
    if (!MontyClass) {
      throw new Error('Python runtime not loaded');
    }
    const inputs = getPythonInputs();
    const fullCode = PYTHON_SHIM + code + '\n\nselect_move()';
    const m = MontyClass.withInputs(fullCode, JSON.stringify(PYTHON_INPUT_NAMES));
    const result = m.runWithInputs(JSON.stringify(inputs));
    return JSON.parse(result);
  }

  async function loadBot(botId, color = null) {
    if (botId === 'python-bot') {
      await loadMonty();
      const code = document.getElementById('python-code').value;
      if (color) {
        pythonBotCode[color] = code;
      }
      return {
        getName: () => 'Python Bot',
        getDescription: () => 'Custom Python bot',
        onGameStart: () => {},
        selectMove: () => {
          const c = color || game.get_turn();
          const botCode = pythonBotCode[c] || code;
          return executePythonBot(botCode);
        },
        suggestMove: () => {
          const c = color || game.get_turn();
          const botCode = pythonBotCode[c] || code;
          return executePythonBot(botCode);
        },
      };
    }
    if (botId === 'random-bot') {
      try {
        const botModule = await import(`${base}bots/random-bot/random_bot.js`);
        const botHost = await import(`${base}bots/bot-host.js`);

        botHost.setGame(game);
        botHost.setLogCallback(addLogEntry);

        return {
          getName: () => botModule.bot.getName(),
          getDescription: () => botModule.bot.getDescription(),
          onGameStart: () => botModule.bot.onGameStart(),
          selectMove: () => botModule.bot.selectMove(),
          suggestMove: () => botModule.bot.suggestMove(),
        };
      } catch (e) {
        addLogEntry(`Error loading bot: ${(e.message || String(e))}`);
        console.error(e);
        return null;
      }
    }
    return null;
  }

  function addLogEntry(message) {
    const logContent = document.getElementById('log-content');
    const entry = document.createElement('div');
    entry.className = 'log-entry';
    entry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
    logContent.appendChild(entry);
    logContent.scrollTop = logContent.scrollHeight;
  }

  // --- Game Init ---
  async function initGame() {
    const { ChessGame } = await loadChessEngine();
    game = new ChessGame();
    renderBoard();
    updateUI();
    setupBotControls();
  }

  function setupBotControls() {
    const whiteSelect = document.getElementById('white-player');
    const blackSelect = document.getElementById('black-player');

    whiteSelect.addEventListener('change', async (e) => {
      const value = e.target.value;
      if (value === 'upload') {
        document.getElementById('bot-upload').click();
        whiteSelect.value = 'human';
        return;
      }

      const modeDiv = document.getElementById('white-bot-mode');

      if (value === 'human') {
        bots.white = null;
        modeDiv.style.display = 'none';
      } else {
        if (value === 'python-bot') {
          // Switch to editor tab
          document.querySelector('.tab[data-tab="editor-tab"]').click();
        }
        bots.white = await loadBot(value, 'white');
        modeDiv.style.display = 'block';
        if (bots.white) {
          addLogEntry(`White: ${bots.white.getName()} loaded`);
        }
      }

      updateBotVsBotUI();
      checkBotTurn();
    });

    blackSelect.addEventListener('change', async (e) => {
      const value = e.target.value;
      if (value === 'upload') {
        document.getElementById('bot-upload').click();
        blackSelect.value = 'human';
        return;
      }

      const modeDiv = document.getElementById('black-bot-mode');

      if (value === 'human') {
        bots.black = null;
        modeDiv.style.display = 'none';
      } else {
        if (value === 'python-bot') {
          document.querySelector('.tab[data-tab="editor-tab"]').click();
        }
        bots.black = await loadBot(value, 'black');
        modeDiv.style.display = 'block';
        if (bots.black) {
          addLogEntry(`Black: ${bots.black.getName()} loaded`);
        }
      }

      updateBotVsBotUI();
      checkBotTurn();
    });

    document.querySelectorAll('input[name="white-mode"]').forEach(radio => {
      radio.addEventListener('change', (e) => {
        botModes.white = e.target.value;
        checkBotTurn();
      });
    });

    document.querySelectorAll('input[name="black-mode"]').forEach(radio => {
      radio.addEventListener('change', (e) => {
        botModes.black = e.target.value;
        checkBotTurn();
      });
    });

    document.getElementById('start-match').addEventListener('click', startBotMatch);
    document.getElementById('pause-match').addEventListener('click', togglePauseMatch);

    document.getElementById('match-speed').addEventListener('input', (e) => {
      document.getElementById('speed-label').textContent = `${e.target.value}ms`;
    });

    document.getElementById('play-suggestion').addEventListener('click', () => {
      if (suggestedMove) {
        makeMove(suggestedMove);
      }
    });

    // Test button: validate code
    document.getElementById('test-python').addEventListener('click', async () => {
      const errorDiv = document.getElementById('python-error');
      const code = document.getElementById('python-code').value;

      try {
        await loadMonty();
        const result = executePythonBot(code);
        const legalMoves = JSON.parse(game.get_legal_moves());

        if (legalMoves.includes(result)) {
          errorDiv.className = 'success';
          errorDiv.style.display = 'block';
          errorDiv.textContent = `Bot selected: ${result}`;
        } else {
          errorDiv.className = '';
          errorDiv.style.display = 'block';
          errorDiv.textContent = `Warning: "${result}" is not a legal move. Legal moves: ${legalMoves.slice(0, 5).join(', ')}...`;
        }
      } catch (e) {
        errorDiv.className = '';
        errorDiv.style.display = 'block';
        errorDiv.textContent = `Error: ${(e.message || String(e))}`;
      }
    });

    // Apply button: re-load bots with new code
    document.getElementById('apply-python').addEventListener('click', async () => {
      const whiteValue = whiteSelect.value;
      const blackValue = blackSelect.value;

      if (whiteValue === 'python-bot') {
        bots.white = await loadBot('python-bot', 'white');
        addLogEntry('White Python bot updated');
      }
      if (blackValue === 'python-bot') {
        bots.black = await loadBot('python-bot', 'black');
        addLogEntry('Black Python bot updated');
      }

      if (whiteValue !== 'python-bot' && blackValue !== 'python-bot') {
        addLogEntry('No Python bot active — select "Python Bot" in Controls tab first');
      }
    });
  }

  // --- Bot Match ---
  function updateBotVsBotUI() {
    const botVsBotControls = document.getElementById('bot-vs-bot-controls');
    if (bots.white && bots.black) {
      botVsBotControls.style.display = 'block';
    } else {
      botVsBotControls.style.display = 'none';
      stopBotMatch();
    }
  }

  function startBotMatch() {
    if (!bots.white || !bots.black) return;

    botModes.white = 'auto';
    botModes.black = 'auto';

    bots.white.onGameStart?.();
    bots.black.onGameStart?.();

    addLogEntry('Bot match started!');
    document.getElementById('start-match').disabled = true;
    document.getElementById('pause-match').disabled = false;
    matchPaused = false;

    playNextBotMove();
  }

  function playNextBotMove() {
    if (matchPaused) return;

    const state = game.get_game_state();
    if (state !== 'in_progress') {
      stopBotMatch();
      return;
    }

    const turn = game.get_turn();
    const bot = turn === 'white' ? bots.white : bots.black;

    if (bot) {
      try {
        const move = bot.selectMove();
        if (move && game.make_move(move)) {
          moveHistory.push(move);
          lastMove = move;
          renderBoard();
          updateUI();

          const speed = parseInt(document.getElementById('match-speed').value);
          matchInterval = setTimeout(playNextBotMove, speed);
        } else {
          addLogEntry(`Invalid move from ${turn}: ${move}`);
          stopBotMatch();
        }
      } catch (e) {
        addLogEntry(`Error: ${(e.message || String(e))}`);
        stopBotMatch();
      }
    }
  }

  function togglePauseMatch() {
    matchPaused = !matchPaused;
    document.getElementById('pause-match').textContent = matchPaused ? 'Resume' : 'Pause';

    if (!matchPaused) {
      playNextBotMove();
    }
  }

  function stopBotMatch() {
    if (matchInterval) {
      clearTimeout(matchInterval);
      matchInterval = null;
    }
    document.getElementById('start-match').disabled = false;
    document.getElementById('pause-match').disabled = true;
    addLogEntry('Bot match ended');
  }

  async function checkBotTurn() {
    const state = game.get_game_state();
    if (state !== 'in_progress') return;

    const turn = game.get_turn();
    const bot = turn === 'white' ? bots.white : bots.black;
    const mode = turn === 'white' ? botModes.white : botModes.black;

    if (bot && mode === 'auto' && !matchInterval) {
      setTimeout(async () => {
        try {
          const move = bot.selectMove();
          if (move && game.make_move(move)) {
            moveHistory.push(move);
            lastMove = move;
            suggestedMove = null;
            renderBoard();
            updateUI();
            checkBotTurn();
          }
        } catch (e) {
          addLogEntry(`Error: ${(e.message || String(e))}`);
        }
      }, 300);
    } else if (bot && mode === 'suggest') {
      try {
        suggestedMove = bot.suggestMove();
        document.getElementById('suggested-move').style.display = 'block';
        document.getElementById('suggestion').textContent = suggestedMove;
        renderBoard();
      } catch (e) {
        addLogEntry(`Error getting suggestion: ${(e.message || String(e))}`);
      }
    } else {
      suggestedMove = null;
      document.getElementById('suggested-move').style.display = 'none';
    }
  }

  // --- Board Rendering ---
  function squareToIndex(sq) {
    const file = sq.charCodeAt(0) - 97;
    const rank = parseInt(sq[1]) - 1;
    return rank * 8 + file;
  }

  function indexToSquare(idx) {
    const file = String.fromCharCode(97 + (idx % 8));
    const rank = Math.floor(idx / 8) + 1;
    return `${file}${rank}`;
  }

  function renderBoard() {
    const board = document.getElementById('chess-board');
    board.innerHTML = '';

    const boardState = JSON.parse(game.get_board_state());
    const isCheck = game.is_check();
    const turn = game.get_turn();

    for (let rank = 7; rank >= 0; rank--) {
      for (let file = 0; file < 8; file++) {
        const idx = rank * 8 + file;
        const sq = indexToSquare(idx);
        const piece = boardState.squares[idx];

        const div = document.createElement('div');
        div.className = `square ${(file + rank) % 2 === 0 ? 'dark' : 'light'}`;
        div.dataset.square = sq;

        if (piece) {
          div.textContent = PIECE_UNICODE[piece.color][piece.piece_type];
          if (piece.piece_type === 'king' && piece.color === turn && isCheck) {
            div.classList.add('check');
          }
        }

        if (selectedSquare === sq) div.classList.add('selected');

        const isLegalMove = legalMoves.some(m => m.slice(2, 4) === sq);
        if (isLegalMove) {
          div.classList.add(piece ? 'legal-capture' : 'legal-move');
        }

        if (lastMove && (sq === lastMove.slice(0, 2) || sq === lastMove.slice(2, 4))) {
          div.classList.add('last-move');
        }

        if (suggestedMove && (sq === suggestedMove.slice(0, 2) || sq === suggestedMove.slice(2, 4))) {
          div.classList.add('suggested');
        }

        div.addEventListener('click', () => handleSquareClick(sq));
        board.appendChild(div);
      }
    }
  }

  function handleSquareClick(sq) {
    const turn = game.get_turn();

    const bot = turn === 'white' ? bots.white : bots.black;
    const mode = turn === 'white' ? botModes.white : botModes.black;
    if (bot && mode === 'auto') return;

    const boardState = JSON.parse(game.get_board_state());
    const idx = squareToIndex(sq);
    const piece = boardState.squares[idx];

    if (selectedSquare) {
      const moveUci = selectedSquare + sq;
      const isLegal = legalMoves.some(m => m.startsWith(moveUci));

      if (isLegal) {
        const fromIdx = squareToIndex(selectedSquare);
        const fromPiece = boardState.squares[fromIdx];
        const toRank = parseInt(sq[1]);

        if (fromPiece && fromPiece.piece_type === 'pawn' &&
            ((turn === 'white' && toRank === 8) || (turn === 'black' && toRank === 1))) {
          showPromotionModal(selectedSquare, sq);
          return;
        }

        makeMove(moveUci);
        return;
      }
    }

    if (piece && piece.color === turn) {
      selectedSquare = sq;
      legalMoves = JSON.parse(game.get_legal_moves()).filter(m => m.startsWith(sq));
    } else {
      selectedSquare = null;
      legalMoves = [];
    }

    renderBoard();
  }

  function showPromotionModal(from, to) {
    const turn = game.get_turn();

    const modal = document.createElement('div');
    modal.className = 'promotion-modal';
    modal.innerHTML = `
      <div class="promotion-choices">
        <div class="promotion-choice" data-piece="q">${PIECE_UNICODE[turn].queen}</div>
        <div class="promotion-choice" data-piece="r">${PIECE_UNICODE[turn].rook}</div>
        <div class="promotion-choice" data-piece="b">${PIECE_UNICODE[turn].bishop}</div>
        <div class="promotion-choice" data-piece="n">${PIECE_UNICODE[turn].knight}</div>
      </div>
    `;

    modal.querySelectorAll('.promotion-choice').forEach(choice => {
      choice.addEventListener('click', () => {
        const piece = choice.dataset.piece;
        makeMove(`${from}${to}${piece}`);
        modal.remove();
      });
    });

    document.body.appendChild(modal);
  }

  function makeMove(uci) {
    if (game.make_move(uci)) {
      moveHistory.push(uci);
      lastMove = uci;
      selectedSquare = null;
      legalMoves = [];
      suggestedMove = null;
      renderBoard();
      updateUI();
      checkBotTurn();
    }
  }

  function updateUI() {
    const turn = game.get_turn();
    const state = game.get_game_state();
    const isCheck = game.is_check();

    const turnIndicator = document.getElementById('turn-indicator');
    turnIndicator.textContent = `${turn === 'white' ? 'White' : 'Black'} to move`;

    const gameStatus = document.getElementById('game-status');
    if (state === 'checkmate') {
      const winner = turn === 'white' ? 'Black' : 'White';
      gameStatus.textContent = `Checkmate! ${winner} wins!`;
      turnIndicator.textContent = '';
    } else if (state === 'stalemate') {
      gameStatus.textContent = 'Stalemate! Draw.';
      turnIndicator.textContent = '';
    } else if (state === 'draw') {
      gameStatus.textContent = 'Draw!';
      turnIndicator.textContent = '';
    } else if (isCheck) {
      gameStatus.textContent = 'Check!';
    } else {
      gameStatus.textContent = '';
    }

    const movesList = document.getElementById('moves-list');
    movesList.innerHTML = '';
    moveHistory.forEach((move, i) => {
      const entry = document.createElement('span');
      entry.className = 'move-entry';
      entry.textContent = `${Math.floor(i / 2) + 1}${i % 2 === 0 ? '.' : '...'} ${move}`;
      movesList.appendChild(entry);
    });

    document.getElementById('undo-btn').disabled = moveHistory.length === 0;
  }

  function resetGame() {
    stopBotMatch();
    game.reset();
    selectedSquare = null;
    legalMoves = [];
    moveHistory = [];
    lastMove = null;
    suggestedMove = null;
    renderBoard();
    updateUI();
    document.getElementById('suggested-move').style.display = 'none';
    checkBotTurn();
  }

  document.getElementById('reset-btn').addEventListener('click', resetGame);

  initGame();
</script>
