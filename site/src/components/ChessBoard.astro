---
import { witCode, pythonExample } from '../assets/string-constants.js';

// Chess Board Component with Bot Support
// Ensure base URL ends with a slash for proper path concatenation
const rawBase = import.meta.env.BASE_URL || '/';
const base = rawBase.endsWith('/') ? rawBase : rawBase + '/';
---

<div id="chess-container" data-base={base}>
  <div id="game-info">
    <div id="turn-indicator">White to move</div>
    <div id="game-status" aria-live="polite"></div>
  </div>

  <div id="main-content">
    <div id="board-column">
      <div id="board-section">
        <!-- Black player bar (plays from top) -->
        <div class="player-bar player-bar-black">
          <label for="black-player" class="player-label">Black:</label>
          <select id="black-player">
            <option value="human">Human</option>
            <option value="random-bot">Random Bot (Rust)</option>
            <option value="smart-bot">Smart Bot (Rust)</option>
            <option value="python-smart-bot">Smart Bot (Python)</option>
            <option value="python-bot">Python Editor Bot</option>
            <option value="upload">Upload Bot...</option>
          </select>
          <div id="black-bot-mode" class="bot-mode" style="display: none;">
            <label><input type="radio" name="black-mode" value="auto"> Auto-play</label>
            <label><input type="radio" name="black-mode" value="suggest" checked> Suggest</label>
          </div>
        </div>

        <!-- Board with coordinate labels -->
        <div id="board-with-coords">
          <div id="rank-labels">
            <span>8</span><span>7</span><span>6</span><span>5</span><span>4</span><span>3</span><span>2</span><span>1</span>
          </div>
          <div id="chess-board"></div>
          <div id="file-labels-spacer"></div>
          <div id="file-labels">
            <span>a</span><span>b</span><span>c</span><span>d</span><span>e</span><span>f</span><span>g</span><span>h</span>
          </div>
        </div>

        <!-- White player bar (plays from bottom) -->
        <div class="player-bar player-bar-white">
          <label for="white-player" class="player-label">White:</label>
          <select id="white-player">
            <option value="human">Human</option>
            <option value="random-bot">Random Bot (Rust)</option>
            <option value="smart-bot">Smart Bot (Rust)</option>
            <option value="python-smart-bot">Smart Bot (Python)</option>
            <option value="python-bot">Python Editor Bot</option>
            <option value="upload">Upload Bot...</option>
          </select>
          <div id="white-bot-mode" class="bot-mode" style="display: none;">
            <label><input type="radio" name="white-mode" value="auto"> Auto-play</label>
            <label><input type="radio" name="white-mode" value="suggest" checked> Suggest</label>
          </div>
        </div>

        <div id="controls">
          <button id="reset-btn" class="btn-danger"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" style="vertical-align: -2px; margin-right: 4px;"><polyline points="1 4 1 10 7 10"></polyline><path d="M3.51 15a9 9 0 1 0 2.13-9.36L1 10"></path></svg>New Game</button>
          <button id="undo-btn" class="btn-secondary" disabled><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" style="vertical-align: -2px; margin-right: 4px;"><polyline points="9 14 4 9 9 4"></polyline><path d="M20 20v-7a4 4 0 0 0-4-4H4"></path></svg>Undo</button>
        </div>
      </div>

      <!-- Game controls (relocated from Controls tab) -->
      <div id="game-controls">
        <div id="bot-vs-bot-controls" style="display: none;">
          <button id="start-match"><svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor" stroke="none" style="vertical-align: -2px; margin-right: 4px;"><polygon points="5 3 19 12 5 21 5 3"></polygon></svg>Start Bot Match</button>
          <button id="pause-match" class="btn-secondary" disabled><svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor" stroke="none" style="vertical-align: -2px; margin-right: 4px;"><rect x="6" y="4" width="4" height="16"></rect><rect x="14" y="4" width="4" height="16"></rect></svg>Pause</button>
          <label>
            Speed: <input type="range" id="match-speed" min="100" max="2000" value="500">
            <span id="speed-label">500ms</span>
          </label>
        </div>

        <div id="suggested-move" style="display: none;">
          <strong>Suggested move:</strong> <span id="suggestion"></span>
          <button id="play-suggestion"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" style="vertical-align: -2px; margin-right: 4px;"><polyline points="20 6 9 17 4 12"></polyline></svg>Play it</button>
        </div>

        <div id="bot-log">
          <h3>Bot Log</h3>
          <div id="log-content"></div>
        </div>
      </div>

      <div id="move-history">
        <h3>Move History</h3>
        <div id="moves-list"></div>
      </div>
    </div>

    <div id="side-panel">
      <div id="tab-bar">
        <button class="tab active" data-tab="wit-tab">Bot Interface</button>
        <button class="tab" data-tab="editor-tab">Python Editor</button>
      </div>

      <div id="tab-content">
        <!-- WIT Interface Tab -->
        <div id="wit-tab" class="tab-pane active">
          <div class="wit-section">
            <h4>Example Bots</h4>
            <div class="bot-cards">
              <div class="bot-card">
                <div class="bot-card-header">
                  <strong>Random Bot</strong>
                  <span class="bot-lang">Rust</span>
                </div>
                <p class="bot-card-desc">Picks a random legal move.</p>
                <div class="bot-card-actions">
                  <button class="bot-load-btn" data-bot="random-bot" data-color="white">Load White</button>
                  <button class="bot-load-btn" data-bot="random-bot" data-color="black">Load Black</button>
                  <a href="https://github.com/sammasak/playground/tree/main/bots/random-bot" target="_blank" rel="noopener noreferrer" class="bot-source-link">Source</a>
                </div>
              </div>
              <div class="bot-card">
                <div class="bot-card-header">
                  <strong>Smart Bot</strong>
                  <span class="bot-lang">Rust</span>
                </div>
                <p class="bot-card-desc">Prefers captures and center control.</p>
                <div class="bot-card-actions">
                  <button class="bot-load-btn" data-bot="smart-bot" data-color="white">Load White</button>
                  <button class="bot-load-btn" data-bot="smart-bot" data-color="black">Load Black</button>
                  <a href="https://github.com/sammasak/playground/tree/main/bots/smart-bot" target="_blank" rel="noopener noreferrer" class="bot-source-link">Source</a>
                </div>
              </div>
              <div class="bot-card">
                <div class="bot-card-header">
                  <strong>Smart Bot</strong>
                  <span class="bot-lang">Python</span>
                </div>
                <p class="bot-card-desc">Same strategy, written in Python.</p>
                <div class="bot-card-actions">
                  <button class="bot-load-btn" data-bot="python-smart-bot" data-color="white">Load White</button>
                  <button class="bot-load-btn" data-bot="python-smart-bot" data-color="black">Load Black</button>
                  <a href="https://github.com/sammasak/playground/tree/main/bots/python-smart-bot" target="_blank" rel="noopener noreferrer" class="bot-source-link">Source</a>
                </div>
              </div>
            </div>
          </div>

          <div class="wit-section">
            <h4>Upload Your Bot</h4>
            <div id="upload-dropzone">
              <svg width="36" height="36" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" style="margin-bottom: 8px; color: var(--color-text-light);"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="17 8 12 3 7 8"></polyline><line x1="12" y1="3" x2="12" y2="15"></line></svg>
              <p>Drop a <code>.wasm</code> bot component here<br>or click to browse</p>
              <p class="upload-note">Must implement <code>chess:bot@0.1.0</code></p>
            </div>
            <div id="upload-status" style="display: none;"></div>
          </div>

          <div class="wit-section">
            <details>
              <summary class="wit-summary">WIT Reference</summary>
              <p class="wit-desc">Bots receive the full board state (with move history) and legal moves, then return a UCI move string.</p>
              <pre id="wit-code" class="code-block">{witCode}</pre>
            </details>
          </div>

          <div class="wit-section">
            <button class="tab-link" data-tab="editor-tab">Open Python Editor →</button>
          </div>
        </div>

        <!-- Python Editor Tab -->
        <div id="editor-tab" class="tab-pane" style="display: none;">
          <div class="editor-header">
            <h4>Python Bot Playground</h4>
            <p class="editor-desc">Implement the WIT bot interface as Python functions. Host functions are globals.</p>
            <p class="editor-desc"><em>Powered by <a href="https://github.com/pydantic/monty" target="_blank" rel="noopener noreferrer">Monty</a> — secure Python subset in WASM</em></p>
          </div>
          <div id="python-code-editor" data-initial-code={pythonExample}></div>
          <div class="editor-actions">
            <button id="test-python"><svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor" stroke="none" style="vertical-align: -2px; margin-right: 4px;"><polygon points="5 3 19 12 5 21 5 3"></polygon></svg>Test Code</button>
            <button id="apply-python"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" style="vertical-align: -2px; margin-right: 4px;"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="17 8 12 3 7 8"></polyline><line x1="12" y1="3" x2="12" y2="15"></line></svg>Apply to Bot</button>
          </div>
          <div id="python-feedback" style="display: none;"></div>
        </div>
      </div>
    </div>
  </div>

  <input type="file" id="bot-upload" accept=".wasm,.js" style="display: none;">
</div>

<style is:global>@import '../assets/chess-board.css';</style>

<script>
  import '../scripts/chess-game.js';
</script>
